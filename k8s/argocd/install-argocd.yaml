# ArgoCD Installation Values
# Apply the official ArgoCD manifests first, then apply this for customization

# To install ArgoCD on your LKE cluster:
# 
# 1. Create namespace:
#    kubectl create namespace argocd
#
# 2. Install ArgoCD:
#    kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
#
# 3. (Optional) Apply this patch for LoadBalancer access:
#    kubectl apply -f install-argocd.yaml
#
# 4. Get initial admin password:
#    kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
#
# 5. Access ArgoCD UI:
#    kubectl port-forward svc/argocd-server -n argocd 8080:443
#    Then open https://localhost:8080

---
# Patch ArgoCD Server to use LoadBalancer (for easy access on Akamai)
apiVersion: v1
kind: Service
metadata:
  name: argocd-server-lb
  namespace: argocd
spec:
  type: LoadBalancer
  selector:
    app.kubernetes.io/name: argocd-server
  ports:
    - name: https
      port: 443
      targetPort: 8080
      protocol: TCP
---
# ArgoCD ConfigMap customization
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
data:
  # URL for ArgoCD (update with your domain)
  url: https://argocd.YOUR_DOMAIN.com
  
  # Enable status badge
  statusbadge.enabled: "true"
  
  # Application health checks
  resource.customizations.health.argoproj.io_Application: |
    hs = {}
    hs.status = "Progressing"
    hs.message = ""
    if obj.status ~= nil then
      if obj.status.health ~= nil then
        hs.status = obj.status.health.status
        if obj.status.health.message ~= nil then
          hs.message = obj.status.health.message
        end
      end
    end
    return hs
---
# ArgoCD RBAC ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-rbac-cm
    app.kubernetes.io/part-of: argocd
data:
  policy.default: role:readonly
  policy.csv: |
    # Admin policy
    p, role:admin, applications, *, */*, allow
    p, role:admin, clusters, *, *, allow
    p, role:admin, repositories, *, *, allow
    p, role:admin, logs, *, *, allow
    p, role:admin, exec, *, *, allow
    
    # Developer policy - can sync but not delete
    p, role:developer, applications, get, */*, allow
    p, role:developer, applications, sync, */*, allow
    p, role:developer, logs, get, */*, allow
    
    # Assign admin role to admin user
    g, admin, role:admin
